{% extends "base.html" %}
{% block title %}Barnacle Delivers{% endblock %}
{% block heading %}{% include "quicksearch.html" %}
{% endblock %}
{% block content %}

<div class="row-fluid" style='margin-left:40px'>
  <div class="span8">  
    <div class="row hidden-phone">
        Current Driver Network:
        <div id="map-canvas" class="homemap"></div>
    </div>

    <div class="row" style='height:10px'></div>
    <div class="row contentpad10">
          <h4>Going on a roadtrip or commuting regularly? Offset your travel expenses.</h4>
    </div><div class="row">
      <div class="span8 offset1">
        <button id='post_btn' class="btn btn-large btn-info">Be a Driver</button>
        &nbsp;&nbsp;
        <a href='/how'><button class="btn btn-large btn-inverse hidden-phone">How it Works</button></a>
      </div>
    </div>    

  </div>
  <div class="span4 contentpad10">
 
    <table class="table table-hover table-bordered" style="background-color:#eee; height:100%; width:90%" id="newsTable">
    <tr><th>
    News
    </th></tr>
    <tr><td>Welcome to Barnacle!</td></tr>
    <!--<tr class='clicky' onclick="document.location.href = '/account';" id='updates'>
    <td>You have no new delivery updates.</td></tr>-->
    </table>
    <div class="fb-follow" data-href="https://www.facebook.com/GoBarnacle" data-width="250" data-show-faces="false" style='padding-top:10px;padding-left:10px;'></div>
    
    <p><br><a href="https://play.google.com/store/apps/details?id=com.gobarnacle"><img width='100px' src="/static/img/icons/play_store.png"></a></p>
  </div>
</div>

<!--
    <div class="row"><div class="span10 contentpad20">
    <h4>Featured Requests</h4>
    <div id='dumpreqs'>
        <table class="table table-hover table-condensed">
        {% for nr in new_requests %}
        <tr class='clicky' onclick="document.location.href = '{{nr.post_url}}';">
            <td><img src="{{nr.prof_img}}" width='64px'></td>
            <td>{{nr.first_name}} needs to send {{nr.reqitems}} from {{nr.locstart}} to {{nr.locend}} by {{nr.delivby}}
            </td>
        </tr>
        {% endfor %}
        </table>
    </div>
    </div></div>
-->    

<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=true&libraries=places"></script>
<script type="text/javascript" src="/static/js/maps/maphome.js"></script>
<script type="text/javascript">
$(document).ready(function(){
    var mapURL = '/post/jsonall';
    initialize_home(mapURL);
    click_redirect('#post_btn','/drive');
    
    /* Get notifications */
    //Matches
  $.ajax({
    type: "GET",
    contentType: "json", 
    url: '/match/matches',
    success: function(q) {
      console.log(q);
      if (q.status=='ok') {
        matchstr='';
        if (parseInt(q.reqcount) > 0) 
          matchstr+='<tr class="clicky" onclick="document.location.href = \'/routes\';"><td>There are '+q.reqcount+ ' driver matches for your delivery requests.</td></tr>';
        if (parseInt(q.routecount) > 0) 
          matchstr+='<tr class="clicky" onclick="document.location.href = \'/routes\';"><td>There are '+q.routecount+ ' delivery requests that match your upcoming routes.</td></tr>';
        if (matchstr != '') {
          $('#newsTable tr:last').after(matchstr);
        }
      }
    },
    error: function(jqXHR, textStatus, errorThrown) {
      console.log(textStatus);
      console.log(jqXHR);
     }
  });        
    
    //If driver, people who need help from your location
  // Try HTML5 geolocation
  data = {};
  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
    data.startlat = position.coords.latitude;
    data.startlon = position.coords.longitude;
    getRequestDump(data); 
    }, function() {
      getRequestDump(data); 
    });
  } else 
    getRequestDump(data);     
});

function postRedir(url) {
  $.ajax({
    type: "POST",
    url: url,
    success: function(q) {
      document.open();
      document.write(q);
      document.close();
    }
  });
}
function getRequestDump(data) {
  $.ajax({
    type: "POST",
    dataType: "json",
    contentType: "json",     
    data: JSON.stringify(data),
    url: '/match/dumprequests',
    success: function(q) {
        console.log(q);
        if (q.status == 'ok') {
          if (parseInt(q.count) > 0) {
            matchstr = '<tr class="clicky" onclick="postRedir(\''+q.link+'\')"><td>'+q.count+ ' users need to send packages from your location. Click to view.</td></tr>';
            $('table#newsTable tr:last').after(matchstr);
          }
        }
      }
  });            
}
</script>
{% endblock %}


